<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Deas Book Log - 1,000 Books in 1,000 Weeks</title>

    <meta property="og:title" content="Dr. Deas Book Log - 1,000 Books in 1,000 Weeks">
    <meta property="og:description" content="Track Dr. Deas's progress in the 1,000 Books in 1,000 Weeks Reading Challenge — a journey through literature, science, and social commentary.">
    <meta property="og:image" content="https://drdeas.github.io/DrDeasBookLog/caged_bird.png">
    <meta property="og:url" content="https://drdeas.github.io/DrDeasBookLog/cover-view.html">
    <meta property="og:type" content="website">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap');

        :root {
            --brand-primary: #667eea;
            --brand-secondary: #764ba2;
            --text-light: #ffffff;
            --text-dark: #333;
            --surface-main: rgba(255, 255, 255, 0.95);
            --surface-secondary: #f8f9fa;
            --surface-inactive: #f5f5f5;
            --shadow-light: rgba(0,0,0,0.1);
            --shadow-medium: rgba(0,0,0,0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .progress-section {
            background: var(--surface-main);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px var(--shadow-medium);
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: var(--text-light);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .progress-bar-container, .weeks-progress-bar-container {
            background: #e0e0e0;
            border-radius: 25px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .weeks-progress-container {
            margin: 20px 0;
        }

        .progress-bar, .weeks-progress-bar {
            height: 100%;
            border-radius: 25px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .weeks-progress-bar {
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
        }

        .progress-bar::after, .weeks-progress-bar::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .btn {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: var(--text-light); padding: 12px 30px; border: none;
            border-radius: 8px; font-size: 16px; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-light); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .books-list {
            background: var(--surface-main); border-radius: 15px;
            padding: 30px; box-shadow: 0 10px 30px var(--shadow-medium);
        }

        .filter-section {
            display: grid; grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px; margin-bottom: 15px; align-items: end;
        }
        
        .search-input, .filter-select {
            padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;
        }
        
        #booksList {
            transition: opacity 0.3s ease-in-out;
        }
        #booksList.updating {
            opacity: 0.5;
            pointer-events: none;
        }

        .book-item {
            background: var(--surface-secondary); border-left: 4px solid var(--brand-primary);
            padding: 20px; margin-bottom: 15px; border-radius: 0 8px 8px 0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; display: grid;
            grid-template-columns: 80px 1fr; gap: 15px; align-items: start;
        }
        .book-item:hover { transform: translateX(5px); box-shadow: 0 4px 12px var(--shadow-light); }
        .book-item.in-progress { border-left-color: #ffc107; background: #fff9e6; }
        .book-item.next { border-left-color: #28a745; background: #f0f9f0; }

        .book-cover {
            width: 80px; height: 120px; border-radius: 4px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light); font-size: 0.8em; text-align: center;
            padding: 5px; box-shadow: 0 2px 8px var(--shadow-light);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; overflow: hidden; 
        }
        .book-cover:hover { transform: scale(1.02); box-shadow: 0 4px 12px var(--shadow-medium); }
        
        .book-number {
            background: var(--brand-primary); color: var(--text-light);
            font-size: 0.8em; padding: 4px 8px; border-radius: 12px;
            font-weight: bold; margin-bottom: 10px; display: inline-block;
        }
        .book-title { font-weight: bold; font-size: 1.2em; color: var(--text-dark); margin-bottom: 5px; }
        .book-author { color: #666; font-style: italic; margin-bottom: 8px; }
        .book-meta { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

        .category-tag, .ownership-tag, .status-badge, .date-tag {
            padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold;
            color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .category-biography { background-color: #F4C430; }
        .category-business { background-color: #CD5C5C; }
        .category-education { background-color: #32CD32; }
        .category-essays-short-stories { background-color: #F0A0A0; }
        .category-finance { background-color: #483D8B; }
        .category-informational { background-color: #4682B4; }
        .category-memoir-autobiography { background-color: #FF8C00; }
        .category-novel { background-color: #DA70D6; }
        .category-philosophy { background-color: #2F4F4F; }
        .category-poetry { background-color: #708090; }
        .category-policy-and-politics { background-color: #477685; }
        .category-race-class-and-gender { background-color: #228B22; }
        .category-religion { background-color: #556B2F; }
        .category-science { background-color: #87CEFA; }
        .category-self-development { background-color: #9370DB; }
        .category-social-sciences { background-color: #A0522D; }
        .category-stage-play { background-color: #5A9678; }
        .category-technology { background-color: #BC8F8F; }

        .ownership-digital { background-color: #228B22; } .ownership-physical { background-color: #32CD32; }
        .ownership-library { background-color: #9370DB; }

        .status-in-progress { background-color: #ffc107; color: var(--text-dark) !important; text-shadow: none; }
        .status-next { background-color: #17a2b8; }
        .date-tag { background-color: #6c757d; }

        .category-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-top: 20px;
        }
        
        .category-stat {
            padding: 15px; border-radius: 8px; text-align: center; font-size: 0.9em;
            cursor: pointer; font-weight: 600; color: var(--text-light);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease, opacity 0.2s ease;
            position: relative;
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        .category-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        
        .category-stat.category-biography { background-color: #F4C430; }
        .category-stat.category-business { background-color: #CD5C5C; }
        .category-stat.category-education { background-color: #32CD32; }
        .category-stat.category-essays-short-stories { background-color: #F0A0A0; }
        .category-stat.category-finance { background-color: #483D8B; }
        .category-stat.category-informational { background-color: #4682B4; }
        .category-stat.category-memoir-autobiography { background-color: #FF8C00; }
        .category-stat.category-novel { background-color: #DA70D6; }
        .category-stat.category-philosophy { background-color: #2F4F4F; }
        .category-stat.category-poetry { background-color: #708090; }
        .category-stat.category-policy-and-politics { background-color: #477685; }
        .category-stat.category-race-class-and-gender { background-color: #228B22; }
        .category-stat.category-religion { background-color: #556B2F; }
        .category-stat.category-science { background-color: #87CEFA; }
        .category-stat.category-self-development { background-color: #9370DB; }
        .category-stat.category-social-sciences { background-color: #A0522D; }
        .category-stat.category-stage-play { background-color: #5A9678; }
        .category-stat.category-technology { background-color: #BC8F8F; }

        .category-stats.filters-active .category-stat:not(.active) {
            background-color: var(--surface-inactive);
            color: var(--text-dark);
            font-weight: 500;
            box-shadow: none;
        }
        .category-stats.filters-active .category-stat:not(.active):hover {
             background-color: #e9e9e9;
        }

        .category-stat.active::after {
            content: '✔'; position: absolute; top: 8px; right: 12px; font-size: 1.1em;
            color: rgba(255, 255, 255, 0.9); text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .applied-filters {
            padding: 15px 0; margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .applied-filters h3 { font-size: 0.9em; color: #555; margin-bottom: 10px; }
        .filter-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .filter-tag {
            background-color: var(--brand-primary); color: white; padding: 6px 12px;
            border-radius: 20px; font-size: 0.9em; display: inline-flex;
            align-items: center; border: none; cursor: pointer;
        }
        .remove-filter { margin-left: 8px; font-weight: bold; font-size: 1.1em;
            cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease;
        }
        .remove-filter:hover { opacity: 1; }
        .clear-all-filters {
            background: none; border: none; color: var(--brand-primary); font-size: 0.9em;
            font-weight: bold; cursor: pointer; text-decoration: underline;
            padding: 5px; margin-left: 10px;
        }

        .clickable-author { cursor: pointer; transition: color 0.2s; }
        .clickable-author:hover { color: var(--brand-primary); text-decoration: underline; }

        .author-view { display: none; }
        .author-view.active { display: block; }
        .author-header {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: var(--text-light); padding: 30px; border-radius: 15px;
            margin-bottom: 30px; text-align: center;
        }
        .back-to-main {
            background: rgba(255,255,255,0.2); color: white; border: none;
            padding: 10px 20px; border-radius: 25px; cursor: pointer;
            margin-bottom: 15px; font-size: 0.9em; transition: background-color 0.2s;
        }
        .back-to-main:hover { background: rgba(255,255,255,0.3); }
        
        .pagination-controls {
            display: flex; justify-content: center; align-items: center;
            margin-top: 20px; gap: 10px;
        }
        .pagination-controls button { padding: 8px 15px; }
        .pagination-info { font-weight: bold; color: #555; }
        
        .visually-hidden {
            position: absolute; width: 1px; height: 1px; margin: -1px;
            padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
        }

        @media (max-width: 768px) {
            .filter-section { grid-template-columns: 1fr; }
            .progress-stats { grid-template-columns: repeat(2, 1fr); }
            .book-item { grid-template-columns: 60px 1fr; gap: 10px; }
            .book-cover { width: 60px; height: 90px; }
            .pagination-controls { flex-wrap: wrap; }
        }

        #chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        #chat-toggle-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 24px; cursor: pointer; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        #chat-window { width: 350px; height: 500px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; }
        #chat-window.hidden { display: none; }
        #chat-header { background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); color: white; padding: 15px; font-weight: bold; }
        #chat-body { flex-grow: 1; padding: 10px; overflow-y: auto; }
        #chat-input-container { display: flex; padding: 10px; border-top: 1px solid #eee; }
        #chat-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px; }
        #send-chat-btn { margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Dr. Deas Book Log</h1>
            <p>1,000 Books in 1,000 Weeks Challenge</p>
            <a href="cover-view.html" class="nav-button" style="display: inline-block; margin-top: 10px; padding: 8px 15px; background-color: var(--brand-primary); color: var(--text-light); text-decoration: none; border-radius: 8px; transition: background-color 0.3s ease;">Switch to Cover View</a>
            <a href="knowledge-map.html">🧠 Knowledge Map</a>
        </div>

        <div class="progress-section">
            <div class="progress-stats">
                <div class="stat-card"><span class="stat-number" id="finishedBooks">0</span><span class="stat-label">Books Finished</span></div>
                <div class="stat-card"><span class="stat-number" id="inProgressBooks">0</span><span class="stat-label">Books in Progress</span></div>
                <div class="stat-card"><span class="stat-number" id="nextBooks">0</span><span class="stat-label">Next to Read</span></div>
                <div class="stat-card"><span class="stat-number" id="averagePerWeek">0.0</span><span class="stat-label">Books/Week</span></div>
                <div class="stat-card"><span class="stat-number" id="challengeEndDate">Dec 2039</span><span class="stat-label">Target End Date</span></div>
            </div>
            
            <div class="weeks-progress-container">
                <div class="weeks-progress-bar-container"><div class="weeks-progress-bar" id="weeksProgressBar" style="width: 0%"></div></div>
                <p style="text-align: center; margin-top: 5px; font-weight: bold;" id="weeksProgressText">Week 1 of 1000 (0.1% Complete)</p>
            </div>
            
            <div class="progress-bar-container"><div class="progress-bar" id="progressBar" style="width: 0%"></div></div>
            <p style="text-align: center; margin-top: 10px; font-weight: bold;" id="progressText">0% of Book Goal Complete (0 / 1000)</p>
            
            <h3 style="text-align: center; margin-top: 30px; margin-bottom: 10px; color: #444;">Filter by Category</h3>
            <div class="category-stats" id="categoryStats"></div>
        </div>

        <div class="books-list" id="mainView">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>Your Book Collection</h2>
            </div>
            <div class="filter-section">
                <input type="text" id="searchInput" class="search-input" placeholder="Search books, authors, or categories...">
                <select id="statusFilter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="Finished">Finished</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Next">Next</option>
                </select>
                <select id="sortBy" class="filter-select">
                    <option value="number">By Number</option>
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="title">By Title</option>
                    <option value="author">By Author</option>
                    <option value="category">By Category</option>
                </select>
                <select id="booksPerPage" class="filter-select">
                    <option value="5">5 per page</option>
                    <option value="10" selected>10 per page</option>
                    <option value="20">20 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all">View All</option>
                </select>
            </div>
            
            <div id="appliedFilters" class="applied-filters" role="status" aria-live="polite"></div>
            <div id="sr-announcement" class="visually-hidden" aria-live="polite"></div>
            
            <div id="booksList"></div>
            <div class="pagination-controls" id="paginationControls">
                <button id="btnFirst" class="btn">First</button>
                <button id="btnPrevious" class="btn">Previous</button>
                <span id="pageInfo" class="pagination-info">Page 1 of 1</span>
                <button id="btnNext" class="btn">Next</button>
                <button id="btnLast" class="btn">Last</button>
            </div>
        </div>

        <div id="authorView" class="author-view">
             <div class="author-header">
                <button class="back-to-main" onclick="showMainView()">← Back to All Books</button>
                <h1 id="authorName">Author Name</h1>
                <p id="authorBookCount">X books in your collection</p>
            </div>
            <div class="books-list">
                <div id="authorBooksList"></div>
            </div>
        </div>
    </div>

    <!-- The data.js file should be in the same directory as this HTML file -->
    <script src="data.js"></script>
    <script>
        // --- GLOBAL VARIABLES (DECLARED BUT NOT INITIALIZED IF THEY DEPEND ON DATA) ---
        const challengeStartDate = new Date('2020-09-27');
        const challengeEndDate = new Date('2039-11-27');
        
        let filteredBooks = []; // This will hold the currently filtered and sorted books
        let activeCategoryFilters = new Set(); // To store active category filters
        let currentPage = 1;
        let totalPages = 1;
        let allCategories = []; // Will be populated after the DOM is loaded
        
        // --- HTML GENERATION FUNCTIONS ---

        // Utility to get a CSS-friendly class name from a category string
        function getCategoryClass(category) {
            if (!category) return 'unknown';
            if (category === "Essay(s)/Short Stories") return "essays-short-stories";
            if (category === "Memoir/Autobiography") return "memoir-autobiography";
            if (category === "Race, Class, and Gender") return "race-class-and-gender";
            if (category === "Social Science(s)") return "social-sciences";
            return category.toLowerCase()
                .replace(/[()]/g, '') // Remove parentheses
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/,/g, '')   // Remove commas
                .replace(/\//g, '-'); // Replace slashes with hyphens
        }

        // Renders authors as clickable spans
        function renderClickableAuthors(authorsString) {
            if (!authorsString) return '';
            const editorMatch = authorsString.match(/\s*\(editors?\)/i);
            const editorDesignation = editorMatch ? editorMatch[0] : '';
            let cleanAuthorsString = authorsString.replace(/\s*\(editors?\)/i, '').trim();
            const standardizedString = cleanAuthorsString.replace(/\s+and\s+|\s*;\s*|\s*&\s*/g, ',');
            const potentialAuthors = standardizedString.split(/\s*,\s*/);
            
            const authors = [];
            const suffixes = new Set(['Jr.', 'Sr.', 'II', 'III', 'IV', 'V', 'Ph.D.', 'M.D.']);

            for (let i = 0; i < potentialAuthors.length; i++) {
                const part = potentialAuthors[i].trim();
                if (part === '') continue;
                if (authors.length > 0 && suffixes.has(part)) {
                    authors[authors.length - 1] += `, ${part}`;
                } else {
                    authors.push(part);
                }
            }

            const clickableAuthors = authors.map(author => {
                const safeAuthor = author.replace(/'/g, "\\'");
                return `<span class="clickable-author" onclick="showAuthorBooks('${safeAuthor}')">${author}</span>`;
            });
            
            let result;
            if (clickableAuthors.length === 1) {
                result = clickableAuthors[0];
            } else if (clickableAuthors.length === 2) {
                result = clickableAuthors.join(' and ');
            } else if (clickableAuthors.length > 2) {
                const lastAuthor = clickableAuthors.pop();
                result = clickableAuthors.join(', ') + ', and ' + lastAuthor;
            } else {
                result = clickableAuthors.join(', ');
            }
            
            return editorDesignation ? `${result} ${editorDesignation}` : result;
        }

        // Generates HTML for a category tag
        function getCategoryTag(category) {
            if (!category) return '';
            const categoryClass = getCategoryClass(category);
            return `<div class="category-tag category-${categoryClass}">${category}</div>`;
        }
        
        // Generates HTML for an ownership tag
        function getOwnershipTag(ownership) {
            if (!ownership) return '';
            const ownershipClass = ownership.toLowerCase();
            return `<div class="ownership-tag ownership-${ownershipClass}">${ownership}</div>`;
        }

        // Generates HTML for a date completed tag
        function getDateTag(dateCompleted) {
            if (!dateCompleted) return '';
            const dateObj = new Date(dateCompleted + 'T00:00:00'); 
            if (isNaN(dateObj.getTime())) return ''; 
            const formattedDate = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
            return `<div class="date-tag">Completed: ${formattedDate}</div>`;
        }

        // Generates HTML for a static status tag
        function getStatusTag(status) {
            if (!status || status === 'Finished') {
                return '';
            }
            const statusClass = status.toLowerCase().replace(' ', '-');
            return `<span class="status-badge status-${statusClass}">${status}</span>`;
        }
        
        // Determines a fallback color for book covers based on category
        function getCoverColor(category) {
            const colors = {
                'Biography': '#F4C430', 'Business': '#CD5C5C', 'Education': '#32CD32',
                'Essay(s)/Short Stories': '#F0A0A0', 'Finance': '#483D8B', 'Informational': '#4682B4',
                'Memoir/Autobiography': '#FF8C00', 'Novel': '#DA70D6', 'Philosophy': '#2F4F4F',
                'Poetry': '#708090', 'Policy and Politics': '#477685', 
                'Race, Class, and Gender': '#228B22', 'Religion': '#556B2F', 'Science': '#87CEFA',
                'Self-Development': '#9370DB', 'Social Science(s)': '#A0522D', 'Stage Play': '#5A9678', 'Technology': '#BC8F8F'
            };
            return colors[category] || '#667eea'; 
        }

        // Generates initials from a book title for fallback cover display
        function getInitials(title) {
            if (!title) return '';
            return title.split(' ').slice(0, 3).map(word => word[0]).join('').toUpperCase();
        }

        // Generates HTML for a non-interactive book cover
        function generateBookCover(title, category, customCoverUrl = null) {
            const title_attr = `title="${title}"`;
            
            if (customCoverUrl) {
                return `
                    <img src="${customCoverUrl}" alt="${title}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" ${title_attr} onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"/>
                    <div style="width: 100%; height: 100%; background: ${getCoverColor(category)}; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9em; text-align: center; padding: 5px; box-sizing: border-box;" ${title_attr}>
                        <div style="font-size: 1.2em; margin-bottom: 5px;">${getInitials(title)}</div>
                        <div style="font-size: 0.7em; line-height: 1.1; word-break: break-word;">${title.length > 20 ? title.substring(0, 17) + '...' : title}</div>
                    </div>`;
            }
            return `
                <div style="width: 100%; height: 100%; background: ${getCoverColor(category)}; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9em; text-align: center; padding: 5px; box-sizing: border-box;" ${title_attr}>
                    <div style="font-size: 1.2em; margin-bottom: 5px;">${getInitials(title)}</div>
                    <div style="font-size: 0.7em; line-height: 1.1; word-break: break-word;">${title.length > 20 ? title.substring(0, 17) + '...' : title}</div>
                </div>`;
        }
        
        // --- VIEW AND STATE MANAGEMENT FUNCTIONS ---

        // Displays books by a specific author
        function showAuthorBooks(authorName) {
            const authorBooks = books.filter(book => {
                if (!book.author) return false;
                const bookAuthors = book.author.split(/\s+and\s+|\s*;\s*|\s*&\s*/).map(a => a.trim());
                return bookAuthors.includes(authorName);
            });

            document.getElementById('mainView').style.display = 'none';
            const authorView = document.getElementById('authorView');
            authorView.classList.add('active');
            document.getElementById('authorName').textContent = authorName;
            document.getElementById('authorBookCount').textContent = `${authorBooks.length} book${authorBooks.length === 1 ? '' : 's'} in your collection`;
            const authorBooksListElement = document.getElementById('authorBooksList');
            authorBooksListElement.innerHTML = '';
            if (authorBooks.length === 0) {
                authorBooksListElement.innerHTML = '<p>No books by this author.</p>';
            } else {
                authorBooks.forEach((book) => {
                    const bookItem = document.createElement('div');
                    bookItem.className = 'book-item';
                    if (book.status === 'In Progress') bookItem.classList.add('in-progress');
                    if (book.status === 'Next') bookItem.classList.add('next');
                    bookItem.innerHTML = `
                        <div class="book-cover">${generateBookCover(book.title, book.category, book.customCoverUrl)}</div>
                        <div>
                            <span class="book-number">#${book.number}</span><h3 class="book-title">${book.title}</h3>
                            <p class="book-author">${renderClickableAuthors(book.author)}</p>
                            <div class="book-meta">${getCategoryTag(book.category)}${getOwnershipTag(book.ownership)}${getStatusTag(book.status)}${getDateTag(book.dateCompleted)}</div>
                        </div>`;
                    authorBooksListElement.appendChild(bookItem);
                });
            }
            window.scrollTo(0, 0);
        }

        // Switches back to the main book list view
        function showMainView() {
            document.getElementById('authorView').classList.remove('active');
            document.getElementById('mainView').style.display = 'block';
            applyFiltersAndSort(); 
            window.scrollTo(0, 0);
        }
        
        // Pagination functions
        function goToFirstPage() { if (currentPage > 1) { currentPage = 1; renderBooksList(); } }
        function goToPreviousPage() { if (currentPage > 1) { currentPage--; renderBooksList(); } }
        function goToNextPage() { if (currentPage < totalPages) { currentPage++; renderBooksList(); } }
        function goToLastPage() { if (currentPage < totalPages) { currentPage = totalPages; renderBooksList(); } }

        // --- RENDERING AND UI UPDATE FUNCTIONS ---

        // Updates all progress statistics and bars
        function updateProgress() {
            const finished = books.filter(b => b.status === 'Finished').length;
            const inProgress = books.filter(b => b.status === 'In Progress').length;
            const next = books.filter(b => b.status === 'Next').length;

            document.getElementById('finishedBooks').textContent = finished;
            document.getElementById('inProgressBooks').textContent = inProgress;
            document.getElementById('nextBooks').textContent = next;

            const today = new Date();
            const weeksElapsed = Math.max(1, Math.floor((today - challengeStartDate) / (1000 * 60 * 60 * 24 * 7)));

            const averagePerWeek = books.length > 0 ? (finished / weeksElapsed).toFixed(1) : '0.0';
            document.getElementById('averagePerWeek').textContent = averagePerWeek;
            
            const targetEndDateFormatted = challengeEndDate.toLocaleDateString(undefined, { year: 'numeric', month: 'short' });
            document.getElementById('challengeEndDate').textContent = targetEndDateFormatted;

            const weeksProgressPercent = (weeksElapsed / 1000 * 100).toFixed(1);
            document.getElementById('weeksProgressBar').style.width = `${weeksProgressPercent}%`;
            document.getElementById('weeksProgressText').textContent = `Week ${weeksElapsed} of 1000 (${weeksProgressPercent}% Complete)`;

            const progressPercent = books.length > 0 ? (finished / 1000 * 100).toFixed(1) : 0;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}% of 1000 Book Goal Complete (${finished} / 1000)`;

            renderCategoryStats();
        }
        
        // Renders the clickable category statistics/filter cards
        function renderCategoryStats() {
            const statsContainer = document.getElementById('categoryStats');
            statsContainer.innerHTML = '';
            statsContainer.classList.toggle('filters-active', activeCategoryFilters.size > 0);

            const categoryCounts = {};
            allCategories.forEach(cat => categoryCounts[cat] = 0);

            books.filter(b => b.status === 'Finished').forEach(book => {
                if (book.category && categoryCounts.hasOwnProperty(book.category)) {
                    categoryCounts[book.category]++;
                }
            });

            allCategories.forEach(category => {
                const count = categoryCounts[category];
                const statDiv = document.createElement('div');
                const categoryClass = getCategoryClass(category);
                statDiv.className = `category-stat category-${categoryClass}`;
                if (activeCategoryFilters.has(category)) {
                    statDiv.classList.add('active');
                }
                statDiv.dataset.category = category;
                statDiv.textContent = `${category}: ${count}`;
                statDiv.setAttribute('role', 'button');
                statDiv.setAttribute('tabindex', '0');
                statDiv.onclick = () => toggleCategoryFilter(category);
                statDiv.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') toggleCategoryFilter(category); };
                statsContainer.appendChild(statDiv);
            });
        }
        
        // Toggles a category filter on/off
        function toggleCategoryFilter(category) {
            if (activeCategoryFilters.has(category)) {
                activeCategoryFilters.delete(category);
            } else {
                activeCategoryFilters.add(category);
            }
            renderCategoryStats(); // Re-render stats to update styles
            renderAppliedFilters();
            applyFiltersAndSort();
        }

        // Renders the list of currently applied filter tags
        function renderAppliedFilters() {
            const container = document.getElementById('appliedFilters');
            container.innerHTML = '';

            if (activeCategoryFilters.size === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const tagsWrapper = document.createElement('div');
            tagsWrapper.className = 'filter-tags';

            const title = document.createElement('h3');
            title.textContent = 'Active Category Filters:';
            container.appendChild(title);

            activeCategoryFilters.forEach(category => {
                const tag = document.createElement('button');
                tag.className = 'filter-tag';
                tag.innerHTML = `${category} <span class="remove-filter" role="button" aria-label="Remove ${category} filter">×</span>`;
                tag.onclick = () => toggleCategoryFilter(category);
                tagsWrapper.appendChild(tag);
            });

            const clearButton = document.createElement('button');
            clearButton.className = 'clear-all-filters';
            clearButton.textContent = 'Clear All Category Filters';
            clearButton.onclick = () => {
                activeCategoryFilters.clear();
                renderCategoryStats();
                renderAppliedFilters();
                applyFiltersAndSort();
            };
            tagsWrapper.appendChild(clearButton);
            container.appendChild(tagsWrapper);
        }
        
        // Announces filter results to screen readers
        function announceResults(count) {
            const announcer = document.getElementById('sr-announcement');
            if (announcer) {
                announcer.textContent = `Showing ${count} books.`;
            }
        }

        // Applies all current filters and sorting, then re-renders the book list
        function applyFiltersAndSort() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredBooks = books.filter(book => {
                const matchesSearch = searchTerm === '' ||
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.category && book.category.toLowerCase().includes(searchTerm));
                
                const matchesCategory = activeCategoryFilters.size === 0 || activeCategoryFilters.has(book.category);
                const matchesStatus = statusFilter === '' || book.status === statusFilter;
                
                return matchesSearch && matchesCategory && matchesStatus;
            });

            switch (sortBy) {
                case 'number': filteredBooks.sort((a, b) => a.number - b.number); break;
                case 'newest': filteredBooks.sort((a, b) => b.id - a.id); break; 
                case 'oldest': filteredBooks.sort((a, b) => a.id - b.id); break;
                case 'title': filteredBooks.sort((a, b) => a.title.localeCompare(b.title)); break;
                case 'author': filteredBooks.sort((a, b) => a.author.localeCompare(b.author)); break;
                case 'category': filteredBooks.sort((a, b) => (a.category || "").localeCompare(b.category || "")); break;
            }
            currentPage = 1;
            
            const listElement = document.getElementById('booksList');
            listElement.classList.add('updating');

            setTimeout(() => {
                renderBooksList();
                listElement.classList.remove('updating');
                announceResults(filteredBooks.length);
            }, 200);
        }

        // Renders the paginated list of books
        function renderBooksList(targetElementId = 'booksList') {
            const listElement = document.getElementById(targetElementId);
            const paginationControls = document.getElementById('paginationControls');
            const pageInfo = document.getElementById('pageInfo');
            const btnFirst = document.getElementById('btnFirst');
            const btnPrevious = document.getElementById('btnPrevious');
            const btnNext = document.getElementById('btnNext');
            const btnLast = document.getElementById('btnLast');

            listElement.innerHTML = '';

            const itemsPerPageElement = document.getElementById('booksPerPage');
            let itemsPerPageSetting = itemsPerPageElement.value;
            let itemsPerPage;

            if (itemsPerPageSetting === "all" || filteredBooks.length === 0) {
                itemsPerPage = filteredBooks.length > 0 ? filteredBooks.length : 1;
                totalPages = 1;
                currentPage = 1; 
                if (paginationControls) paginationControls.style.display = 'none';
            } else {
                itemsPerPage = parseInt(itemsPerPageSetting);
                totalPages = Math.ceil(filteredBooks.length / itemsPerPage);
                if (paginationControls) paginationControls.style.display = 'flex';
            }
            
            currentPage = Math.max(1, Math.min(currentPage, totalPages));

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const displayBooks = filteredBooks.slice(startIndex, endIndex);

            if (filteredBooks.length === 0) { 
                listElement.innerHTML = '<p style="text-align:center; padding: 20px;">No books match your criteria.</p>';
            } else if (displayBooks.length === 0 && filteredBooks.length > 0) {
                 listElement.innerHTML = '<p style="text-align:center; padding: 20px;">No books on this page. Try another page or adjust filters.</p>';
            }
            else {
                displayBooks.forEach((book) => { 
                    const bookItem = document.createElement('div');
                    bookItem.className = 'book-item';
                    if (book.status === 'In Progress') bookItem.classList.add('in-progress');
                    if (book.status === 'Next') bookItem.classList.add('next');
                    bookItem.innerHTML = `
                        <div class="book-cover">${generateBookCover(book.title, book.category, book.customCoverUrl)}</div>
                        <div>
                            <span class="book-number">#${book.number}</span>
                            <h3 class="book-title">${book.title}</h3>
                            <p class="book-author">${renderClickableAuthors(book.author)}</p>
                            <div class="book-meta">
                                ${getCategoryTag(book.category)}
                                ${getOwnershipTag(book.ownership)}
                                ${getStatusTag(book.status)}
                                ${getDateTag(book.dateCompleted)}
                            </div>
                        </div>`;
                    listElement.appendChild(bookItem);
                });
            }

            if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            if (btnFirst) btnFirst.disabled = currentPage === 1;
            if (btnPrevious) btnPrevious.disabled = currentPage === 1;
            if (btnNext) btnNext.disabled = currentPage === totalPages || totalPages === 0;
            if (btnLast) btnLast.disabled = currentPage === totalPages || totalPages === 0;
        }

        // --- CHAT WIDGET FUNCTIONS ---
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const chatBody = document.getElementById('chat-body');
            const userQuery = input.value.trim();

            if (!userQuery) return;

            // Display user's message
            chatBody.innerHTML += `<div class="user-message" style="text-align: right; margin: 5px; padding: 8px; background-color: #e1f5fe; border-radius: 10px; display: inline-block; max-width: 80%; float: right; clear: both;">${userQuery}</div>`;
            input.value = '';

            // Display a loading indicator
            chatBody.innerHTML += `<div class="ai-message loading" style="text-align: left; margin: 5px; padding: 8px; background-color: #f1f1f1; border-radius: 10px; display: inline-block; max-width: 80%; float: left; clear: both;">Thinking...</div>`;
            chatBody.scrollTop = chatBody.scrollHeight;

            try {
                // NOTE: This fetch call will not work in this environment without a backend.
                // This is placeholder logic for a real implementation.
                const response = await fetch('https://drdeas-reading-assistant.onrender.com/api/chat', { // URL of your backend
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Since rawCsvData is no longer a global, we can't pass it directly.
                        // For a real implementation, you might send the user query and have the backend access the data.
                        query: userQuery
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }

                const data = await response.json();
                const loadingMessage = document.querySelector('.ai-message.loading');
                loadingMessage.classList.remove('loading');
                loadingMessage.innerHTML = data.reply.replace(/\n/g, '<br>');
                chatBody.scrollTop = chatBody.scrollHeight;

            } catch (error) {
                console.error('Fetch error:', error);
                const loadingMessage = document.querySelector('.ai-message.loading');
                if (loadingMessage) {
                    loadingMessage.innerHTML = `<p>Sorry, I couldn't connect to the reading assistant.</p>`;
                }
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Now that the DOM is loaded, we can safely use the 'books' constant from data.js
            allCategories = [...new Set(books.map(book => book.category).filter(Boolean))].sort();
            
            document.getElementById('searchInput').addEventListener('input', applyFiltersAndSort);
            document.getElementById('statusFilter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sortBy').addEventListener('change', applyFiltersAndSort);
            document.getElementById('booksPerPage').addEventListener('change', () => {
                currentPage = 1; 
                renderBooksList();
            });

            document.getElementById('btnFirst').addEventListener('click', goToFirstPage);
            document.getElementById('btnPrevious').addEventListener('click', goToPreviousPage);
            document.getElementById('btnNext').addEventListener('click', goToNextPage);
            document.getElementById('btnLast').addEventListener('click', goToLastPage);
            
            updateProgress(); 
            renderAppliedFilters();
            applyFiltersAndSort();
            
            document.getElementById('chat-toggle-btn').addEventListener('click', () => {
                document.getElementById('chat-window').classList.toggle('hidden');
            });

            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });
    </script>
    
    <div id="chat-widget">
        <div id="chat-window" class="hidden">
            <div id="chat-header">Dr. Deas Reading Assistant</div>
            <div id="chat-body"></div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Ask about your books...">
                <button id="send-chat-btn" class="btn">Send</button>
            </div>
        </div>
        <button id="chat-toggle-btn" class="btn">💬</button>
    </div>

</body>
</html>
